import streamlit as st
import pandas as pd
import numpy as np
import yfinance as yf
import gspread
import time
from google.oauth2.service_account import Credentials

st.set_page_config(page_title="üìä Aktieanalys och investeringsf√∂rslag", layout="wide")

# Google Sheets-koppling
SHEET_URL = st.secrets["SHEET_URL"]
SHEET_NAME = "Blad1"

scope = ["https://spreadsheets.google.com/feeds", "https://www.googleapis.com/auth/drive"]
credentials = Credentials.from_service_account_info(st.secrets["GOOGLE_CREDENTIALS"], scopes=scope)
client = gspread.authorize(credentials)

# H√•rdkodade valutakurser till SEK
STANDARD_VALUTAKURSER = {
    "USD": 9.75,
    "NOK": 0.95,
    "CAD": 7.05,
    "EUR": 11.18,
    "SEK": 1.0
}

def skapa_koppling():
    return client.open_by_url(SHEET_URL).worksheet(SHEET_NAME)

def hamta_data():
    return pd.DataFrame(skapa_koppling().get_all_records())

def spara_data(df):
    sheet = skapa_koppling()
    sheet.clear()
    sheet.update([df.columns.values.tolist()] + df.astype(str).values.tolist())

def s√§kerst√§ll_kolumner(df):
    beh√•ll_kolumner = [
        "Ticker", "Bolagsnamn", "Aktuell kurs", "Valuta", "√Örlig utdelning",
        "Utest√•ende aktier", "P/S", "P/S Q1", "P/S Q2", "P/S Q3", "P/S Q4",
        "Oms√§ttning idag", "Oms√§ttning n√§sta √•r", "Oms√§ttning om 2 √•r", "Oms√§ttning om 3 √•r",
        "P/S-snitt", "Riktkurs idag", "Riktkurs om 1 √•r", "Riktkurs om 2 √•r", "Riktkurs om 3 √•r",
        "Antal aktier", "CAGR 5 √•r (%)"
    ]

    for kol in beh√•ll_kolumner:
        if kol not in df.columns:
            if "kurs" in kol.lower() or "oms√§ttning" in kol.lower() or "p/s" in kol.lower() or "utdelning" in kol.lower() or "cagr" in kol.lower():
                df[kol] = 0.0
            else:
                df[kol] = ""

    # Ta bort o√∂nskade kolumner
    df = df[beh√•ll_kolumner]
    return df

def konvertera_typer(df):
    num_kolumner = [
        "Aktuell kurs", "√Örlig utdelning", "Utest√•ende aktier", "P/S", "P/S Q1", "P/S Q2", "P/S Q3", "P/S Q4",
        "Oms√§ttning idag", "Oms√§ttning n√§sta √•r", "Oms√§ttning om 2 √•r", "Oms√§ttning om 3 √•r",
        "P/S-snitt", "Riktkurs idag", "Riktkurs om 1 √•r", "Riktkurs om 2 √•r", "Riktkurs om 3 √•r",
        "Antal aktier", "CAGR 5 √•r (%)"
    ]
    for kol in num_kolumner:
        if kol in df.columns:
            df[kol] = pd.to_numeric(df[kol], errors="coerce").fillna(0.0)
    return df

def hamta_data_yahoo(ticker):
    try:
        info = yf.Ticker(ticker).info
        kurs = info.get("currentPrice") or info.get("regularMarketPrice")
        valuta = info.get("currency", "USD")
        utdelning = info.get("dividendRate", 0.0)
        cagr = info.get("fiveYearAvgDividendYield", None)
        if cagr is None:
            cagr = 0.0
        return {
            "Aktuell kurs": kurs or 0.0,
            "Valuta": valuta,
            "√Örlig utdelning": utdelning or 0.0,
            "Bolagsnamn": info.get("shortName", ticker),
            "CAGR 5 √•r (%)": cagr
        }
    except:
        return None

def uppdatera_ber√§kningar(df):
    for i, rad in df.iterrows():
        ps = [rad["P/S Q1"], rad["P/S Q2"], rad["P/S Q3"], rad["P/S Q4"]]
        ps = [x for x in ps if x > 0]
        ps_snitt = round(np.mean(ps), 2) if ps else 0.0
        df.at[i, "P/S-snitt"] = ps_snitt

        cagr = rad["CAGR 5 √•r (%)"] / 100
        oms_nasta_ar = rad["Oms√§ttning n√§sta √•r"]

        if oms_nasta_ar > 0 and cagr > 0:
            df.at[i, "Oms√§ttning om 2 √•r"] = round(oms_nasta_ar * (1 + cagr), 2)
            df.at[i, "Oms√§ttning om 3 √•r"] = round(oms_nasta_ar * ((1 + cagr) ** 2), 2)

        utest_aktier = rad["Utest√•ende aktier"]
        if utest_aktier > 0 and ps_snitt > 0:
            df.at[i, "Riktkurs idag"] = round((rad["Oms√§ttning idag"] * ps_snitt) / utest_aktier, 2)
            df.at[i, "Riktkurs om 1 √•r"] = round((oms_nasta_ar * ps_snitt) / utest_aktier, 2)
            df.at[i, "Riktkurs om 2 √•r"] = round((df.at[i, "Oms√§ttning om 2 √•r"] * ps_snitt) / utest_aktier, 2)
            df.at[i, "Riktkurs om 3 √•r"] = round((df.at[i, "Oms√§ttning om 3 √•r"] * ps_snitt) / utest_aktier, 2)
    return df

def hamta_data_yahoo(ticker):
    try:
        info = yf.Ticker(ticker).info
        return {
            "Bolagsnamn": info.get("shortName", ""),
            "Aktuell kurs": info.get("regularMarketPrice", 0.0),
            "Valuta": info.get("currency", "USD"),
            "√Örlig utdelning": info.get("dividendRate", 0.0),
            "CAGR 5 √•r (%)": info.get("revenueGrowth", 0.0) * 100 if info.get("revenueGrowth") else 0.0
        }
    except:
        return {}

def lagg_till_eller_uppdatera(df):
    st.subheader("‚ûï L√§gg till / uppdatera bolag")
    tickers = df["Ticker"].dropna().unique()
    valt = st.selectbox("V√§lj bolag att uppdatera (eller l√§mna tom f√∂r nytt)", [""] + sorted(tickers))

    befintlig = df[df["Ticker"] == valt].iloc[0] if valt else pd.Series(dtype=object)

    with st.form("form"):
        ticker = st.text_input("Ticker", value=befintlig.get("Ticker", "")).upper()
        klick = st.form_submit_button("H√§mta fr√•n Yahoo Finance")

        if klick and ticker:
            data = hamta_data_yahoo(ticker)
            st.session_state.yahoo_data = data
            st.success("Data h√§mtad fr√•n Yahoo Finance")

        data = st.session_state.get("yahoo_data", {})

        namn = st.text_input("Bolagsnamn", value=data.get("Bolagsnamn", befintlig.get("Bolagsnamn", "")))
        kurs = st.number_input("Aktuell kurs", value=float(data.get("Aktuell kurs", befintlig.get("Aktuell kurs", 0.0))))
        valuta = st.selectbox("Valuta", ["USD", "SEK", "NOK", "EUR", "CAD"], index=["USD", "SEK", "NOK", "EUR", "CAD"].index(data.get("Valuta", befintlig.get("Valuta", "USD"))))
        utdelning = st.number_input("√Örlig utdelning", value=float(data.get("√Örlig utdelning", befintlig.get("√Örlig utdelning", 0.0))))
        cagr = st.number_input("CAGR 5 √•r (%)", value=float(data.get("CAGR 5 √•r (%)", befintlig.get("CAGR 5 √•r (%)", 0.0))))

        aktier = st.number_input("Utest√•ende aktier", value=float(befintlig.get("Utest√•ende aktier", 0.0)))
        antal = st.number_input("Antal aktier du √§ger", value=float(befintlig.get("Antal aktier", 0.0)))
        ps = st.number_input("P/S", value=float(befintlig.get("P/S", 0.0)))
        ps_q1 = st.number_input("P/S Q1", value=float(befintlig.get("P/S Q1", 0.0)))
        ps_q2 = st.number_input("P/S Q2", value=float(befintlig.get("P/S Q2", 0.0)))
        ps_q3 = st.number_input("P/S Q3", value=float(befintlig.get("P/S Q3", 0.0)))
        ps_q4 = st.number_input("P/S Q4", value=float(befintlig.get("P/S Q4", 0.0)))

        oms_idag = st.number_input("Oms√§ttning idag", value=float(befintlig.get("Oms√§ttning idag", 0.0)))
        oms_1 = st.number_input("Oms√§ttning n√§sta √•r", value=float(befintlig.get("Oms√§ttning n√§sta √•r", 0.0)))

        spara = st.form_submit_button("üíæ Spara")

    if spara and ticker:
        ny_rad = {
            "Ticker": ticker,
            "Bolagsnamn": namn,
            "Aktuell kurs": kurs,
            "Valuta": valuta,
            "√Örlig utdelning": utdelning,
            "CAGR 5 √•r (%)": cagr,
            "Utest√•ende aktier": aktier,
            "Antal aktier": antal,
            "P/S": ps,
            "P/S Q1": ps_q1,
            "P/S Q2": ps_q2,
            "P/S Q3": ps_q3,
            "P/S Q4": ps_q4,
            "Oms√§ttning idag": oms_idag,
            "Oms√§ttning n√§sta √•r": oms_1
        }

        df = df[df["Ticker"] != ticker]
        df = pd.concat([df, pd.DataFrame([ny_rad])], ignore_index=True)
        st.success(f"{ticker} sparat eller uppdaterat.")

    return df

def analysvy(df):
    st.subheader("üìä Analys och investeringsf√∂rslag")

    st.markdown("#### Filtrering")
    min_da = st.slider("Min direktavkastning (%)", 0.0, 20.0, 0.0, step=0.1)
    max_da = st.slider("Max direktavkastning (%)", 0.0, 20.0, 20.0, step=0.1)
    cagr_min = st.slider("Min CAGR 5 √•r (%)", 0.0, 50.0, 0.0, step=0.5)
    endast_med_eps = st.checkbox("Visa endast bolag med v√§xande oms√§ttning (√•r 2 > √•r 1)")

    df["Direktavkastning (%)"] = pd.to_numeric(df["√Örlig utdelning"], errors="coerce") / pd.to_numeric(df["Aktuell kurs"], errors="coerce") * 100
    df["P/S snitt"] = df[["P/S Q1", "P/S Q2", "P/S Q3", "P/S Q4"]].mean(axis=1)

    df["Riktkurs om 1 √•r"] = df["P/S snitt"] * df["Oms√§ttning n√§sta √•r"] / df["Utest√•ende aktier"]
    df["Riktkurs om 2 √•r"] = df["P/S snitt"] * df["Oms√§ttning om 2 √•r"] / df["Utest√•ende aktier"]
    df["Riktkurs om 3 √•r"] = df["P/S snitt"] * df["Oms√§ttning om 3 √•r"] / df["Utest√•ende aktier"]

    df_filtered = df[
        (df["Direktavkastning (%)"] >= min_da) &
        (df["Direktavkastning (%)"] <= max_da) &
        (df["CAGR 5 √•r (%)"] >= cagr_min)
    ]

    if endast_med_eps:
        df_filtered = df_filtered[df_filtered["Oms√§ttning om 2 √•r"] > df_filtered["Oms√§ttning n√§sta √•r"]]

    st.write(f"üîé Visar {len(df_filtered)} bolag")
    st.dataframe(df_filtered)

    st.markdown("---")
    st.markdown("### Uppdatera hela databasen fr√•n Yahoo Finance")
    if st.button("üîÑ Massuppdatera alla bolag"):
        ny_df = []
        for i, rad in df.iterrows():
            st.info(f"H√§mtar data f√∂r {rad['Ticker']} ({i+1}/{len(df)})...")
            data = hamta_data_yahoo(rad["Ticker"])
            time.sleep(1)

            rad["Bolagsnamn"] = data.get("Bolagsnamn", rad["Bolagsnamn"])
            rad["Aktuell kurs"] = data.get("Aktuell kurs", rad["Aktuell kurs"])
            rad["Valuta"] = data.get("Valuta", rad["Valuta"])
            rad["√Örlig utdelning"] = data.get("√Örlig utdelning", rad["√Örlig utdelning"])
            rad["CAGR 5 √•r (%)"] = data.get("CAGR 5 √•r (%)", rad["CAGR 5 √•r (%)"])

            if pd.notna(rad["CAGR 5 √•r (%)"]) and rad["Oms√§ttning n√§sta √•r"] > 0:
                tillv√§xt = 1 + (rad["CAGR 5 √•r (%)"] / 100)
                rad["Oms√§ttning om 2 √•r"] = round(rad["Oms√§ttning n√§sta √•r"] * tillv√§xt, 2)
                rad["Oms√§ttning om 3 √•r"] = round(rad["Oms√§ttning n√§sta √•r"] * tillv√§xt**2, 2)

            ny_df.append(rad)

        ny_df = pd.DataFrame(ny_df)
        spara_data(ny_df)
        st.success("‚úÖ Databasen √§r uppdaterad")

def main():
    st.set_page_config(page_title="üìä Aktieanalys & investeringsf√∂rslag", layout="wide")
    st.title("üìä Aktieanalys & investeringsf√∂rslag")

    df = hamta_data()
    df = s√§kerst√§ll_kolumner(df)
    df = konvertera_typer(df)

    meny = st.sidebar.radio("üìå V√§lj vy", [
        "Analys", "L√§gg till / uppdatera bolag", "Portf√∂lj", "Massuppdatera fr√•n Yahoo"
    ])

    valutakurser = {
        "USD": 9.75,
        "NOK": 0.95,
        "CAD": 7.05,
        "EUR": 11.18,
        "SEK": 1.0
    }

    if meny == "Analys":
        analysvy(df)
    elif meny == "L√§gg till / uppdatera bolag":
        df = lagg_till_eller_uppdatera(df)
        spara_data(df)
    elif meny == "Portf√∂lj":
        visa_portfolj(df, valutakurser)
    elif meny == "Massuppdatera fr√•n Yahoo":
        st.warning("Flyttad ‚Äì Anv√§nd knappen l√§ngst ned i analysvyn ist√§llet.")

if __name__ == "__main__":
    main()
